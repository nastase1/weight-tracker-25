name: CI/CD Pipeline

on:
  push:
    branches: [ main, dev , pipeline-ver-db]
  pull_request:
    branches: [ main, dev ]

env:
  DOTNET_VERSION: '9.0.x'
  REGISTRY: ghcr.io
  VERSION_FILE: version.txt

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for versioning
      
    - name: Generate version
      id: version
      run: |
        # Read base version from version.txt
        BASE_VERSION=$(grep "VERSION=" version.txt | cut -d'=' -f2)
        echo "Base version: $BASE_VERSION"
        
        # Generate build number from commit count
        BUILD_NUMBER=${{ github.run_number }}
        
        # For main branch, use semantic versioning
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          VERSION="${BASE_VERSION}.${BUILD_NUMBER}"
          ASSEMBLY_VERSION="${BASE_VERSION}.${BUILD_NUMBER}"
          echo "Main branch version: ${VERSION}"
        else
          # For other branches, use numeric version for assembly, include branch in informational version
          ASSEMBLY_VERSION="${BASE_VERSION}.${BUILD_NUMBER}"
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9]/-/g')
          VERSION="${BASE_VERSION}-${BRANCH_NAME}.${BUILD_NUMBER}"
          echo "Branch version: ${VERSION} (Assembly: ${ASSEMBLY_VERSION})"
        fi
        
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "assembly_version=${ASSEMBLY_VERSION}" >> $GITHUB_OUTPUT
        echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
        echo "Generated version: ${VERSION}"
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
        
    - name: Restore dependencies
      run: dotnet restore WeightTracker25/WeightTracker25.sln
      
    - name: Update version in project files
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        ASSEMBLY_VERSION="${{ steps.version.outputs.assembly_version }}"
        echo "Updating version to: $VERSION"
        echo "Assembly version: $ASSEMBLY_VERSION"
        
        # Update WeightTracker.API.csproj
        # Version and InformationalVersion can have branch suffix
        sed -i "s|<Version>.*</Version>|<Version>$VERSION</Version>|g" WeightTracker25/WeightTracker.API/WeightTracker.API.csproj
        sed -i "s|<InformationalVersion>.*</InformationalVersion>|<InformationalVersion>$VERSION</InformationalVersion>|g" WeightTracker25/WeightTracker.API/WeightTracker.API.csproj
        
        # AssemblyVersion and FileVersion must be numeric only (no branch suffix)
        sed -i "s|<AssemblyVersion>.*</AssemblyVersion>|<AssemblyVersion>$ASSEMBLY_VERSION.0</AssemblyVersion>|g" WeightTracker25/WeightTracker.API/WeightTracker.API.csproj
        sed -i "s|<FileVersion>.*</FileVersion>|<FileVersion>$ASSEMBLY_VERSION.0</FileVersion>|g" WeightTracker25/WeightTracker.API/WeightTracker.API.csproj
        
        echo "Version updated in project files"
    
    - name: Build solution
      run: |
        dotnet build WeightTracker25/WeightTracker25.sln \
          --no-restore \
          --configuration Release \
          /p:Version="${{ steps.version.outputs.version }}"

    - name: Run tests
      run: |
        dotnet test WeightTracker25/WeightTracker25.sln \
          --no-build \
          --configuration Release \
          --verbosity minimal

    - name: Verify migrations
      run: |
        cd WeightTracker25/WeightTracker.Infrastructure
        dotnet ef migrations list --startup-project ../WeightTracker.API --context WeightTrackerDbContext
