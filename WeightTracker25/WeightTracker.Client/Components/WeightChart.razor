@using Microsoft.AspNetCore.Components

<div class="simple-chart-container">
    @if (Data?.Any() == true)
    {
        <div class="chart-header">
            <div class="time-period-filters">
                <button class="filter-btn @(selectedPeriod == TimePeriod.Week ? "active" : "")" 
                        @onclick="() => SelectTimePeriod(TimePeriod.Week)">1W</button>
                <button class="filter-btn @(selectedPeriod == TimePeriod.Month ? "active" : "")" 
                        @onclick="() => SelectTimePeriod(TimePeriod.Month)">1M</button>
                <button class="filter-btn @(selectedPeriod == TimePeriod.ThreeMonths ? "active" : "")" 
                        @onclick="() => SelectTimePeriod(TimePeriod.ThreeMonths)">3M</button>
                <button class="filter-btn @(selectedPeriod == TimePeriod.Year ? "active" : "")" 
                        @onclick="() => SelectTimePeriod(TimePeriod.Year)">1Y</button>
                <button class="filter-btn @(selectedPeriod == TimePeriod.AllTime ? "active" : "")" 
                        @onclick="() => SelectTimePeriod(TimePeriod.AllTime)">All</button>
            </div>
        </div>
        <div class="simple-chart">
            <div class="chart-wrapper">
                <div class="y-labels">
                    @for (int i = 0; i <= 5; i++)
                    {
                        var weight = maxWeight - (i * (maxWeight - minWeight) / 5);
                        <div class="y-label">@weight.ToString("F1")</div>
                    }
                </div>
                <div class="chart-area">
                    <svg viewBox="0 0 700 220" class="chart-svg">
                        <!-- Horizontal grid lines -->
                        @for (int i = 0; i <= 5; i++)
                        {
                            var y = i * 40;
                            <line x1="0" y1="@y" x2="700" y2="@y" stroke="#e2e8f0" stroke-width="1" stroke-dasharray="2,2"/>
                        }
                        
                        <!-- Vertical grid lines -->
                        @if (chartPoints.Count > 1)
                        {
                            @for (int i = 0; i < Math.Min(7, chartPoints.Count); i++)
                            {
                                var x = i * 700.0 / Math.Max(1, Math.Min(6, chartPoints.Count - 1));
                                <line x1="@x.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)" y1="0" x2="@x.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)" y2="200" stroke="#f1f5f9" stroke-width="1"/>
                            }
                        }
                        
                        <!-- Chart area gradient -->
                        <defs>
                            <linearGradient id="areaGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#f1a363;stop-opacity:0.2" />
                                <stop offset="100%" style="stop-color:#f1a363;stop-opacity:0" />
                            </linearGradient>
                        </defs>
                        
                        <!-- Chart area fill -->
                        @if (chartPoints.Count > 1)
                        {
                            <path d="@GetAreaPath()" fill="url(#areaGradient)"/>
                        }
                        
                        <!-- Chart line -->
                        @if (chartPoints.Count > 1)
                        {
                            <path d="@GetLinePath()" 
                                  fill="none" 
                                  stroke="#f1a363" 
                                  stroke-width="3"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"/>
                            
                            <!-- Smoothed trend line -->
                            <path d="@GetSmoothedLinePath()" 
                                  fill="none" 
                                  stroke="#e054e0" 
                                  stroke-width="2"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                  stroke-dasharray="8,4"
                                  opacity="0.8"/>
                            
                            <!-- Data points -->
                            @foreach (var point in chartPoints)
                            {
                                <g class="data-point" @onclick="() => ShowEditPopup(point)" @onmouseenter="(e) => ShowTooltip(point, e)" @onmouseleave="HideTooltip" @onmousemove="(e) => ShowTooltip(point, e)">
                                    <circle cx="@point.X.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)" cy="@point.Y.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)" r="4" fill="#ffffff" stroke="#f1a363" stroke-width="2" style="cursor: pointer;"/>
                                    <circle cx="@point.X.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)" cy="@point.Y.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)" r="2" fill="#f1a363" style="cursor: pointer;"/>
                                </g>
                            }
                        }
                        else if (chartPoints.Count == 1)
                        {
                            <!-- Single data point -->
                            <g class="data-point" @onclick="() => ShowEditPopup(chartPoints[0])" @onmouseenter="(e) => ShowTooltip(chartPoints[0], e)" @onmouseleave="HideTooltip" @onmousemove="(e) => ShowTooltip(chartPoints[0], e)">
                                <circle cx="@chartPoints[0].X.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)" cy="@chartPoints[0].Y.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)" r="6" fill="#ffffff" stroke="#f1a363" stroke-width="3" style="cursor: pointer;"/>
                                <circle cx="@chartPoints[0].X.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)" cy="@chartPoints[0].Y.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)" r="3" fill="#f1a363" style="cursor: pointer;"/>
                            </g>
                        }
                    </svg>
                    
                    <!-- Date labels -->
                    @if (filteredData.Any())
                    {
                        <div class="date-labels">
                            @foreach (var label in GetDateLabels())
                            {
                                <div class="date-label" style="left: @(label.Position)%">@label.Text</div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
        
        <!-- Tooltip -->
        @if (showTooltip && tooltipData != null)
        {
            <div class="chart-tooltip" style="position: fixed; left: @(tooltipX)px; top: @(tooltipY)px; z-index: 1000;">
                <div class="tooltip-content">
                    <div class="tooltip-date">@tooltipData.Date.ToString("MMM dd, yyyy")</div>
                    <div class="tooltip-weight">@tooltipData.Weight.ToString("F1") kg</div>
                </div>
            </div>
        }
        
        <!-- Edit Popup -->
        @if (showEditPopup && selectedPoint != null)
        {
            <div class="popup-overlay" @onclick="CloseEditPopup">
                <div class="edit-popup" @onclick:stopPropagation="true">
                    <div class="popup-header">
                        <h3>Edit Weight Entry</h3>
                        <button class="close-btn" @onclick="CloseEditPopup">&times;</button>
                    </div>
                    <div class="popup-content">
                        <div class="form-group">
                            <label>Date:</label>
                            <input type="date" @bind="editDate" @bind:format="yyyy-MM-dd" />
                        </div>
                        <div class="form-group">
                            <label>Weight (kg):</label>
                            <input type="number" @bind="editWeight" step="0.1" min="1" max="1000" />
                        </div>
                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="error-message">@errorMessage</div>
                        }
                    </div>
                    <div class="popup-actions">
                        <button class="btn btn-danger" @onclick="DeleteRecord" disabled="@isProcessing">
                            @if (isProcessing && currentAction == "delete")
                            {
                                <span>Deleting...</span>
                            }
                            else
                            {
                                <span>Delete</span>
                            }
                        </button>
                        <button class="btn btn-primary" @onclick="UpdateRecord" disabled="@isProcessing">
                            @if (isProcessing && currentAction == "update")
                            {
                                <span>Updating...</span>
                            }
                            else
                            {
                                <span>Update</span>
                            }
                        </button>
                        <button class="btn btn-secondary" @onclick="CloseEditPopup" disabled="@isProcessing">Cancel</button>
                    </div>
                </div>
            </div>
        }
        
        <div class="chart-footer">
            <span class="chart-range">@minWeight.ToString("F1") kg - @maxWeight.ToString("F1") kg</span>
            <span class="chart-info">@filteredData.Count entries â€¢ @GetPeriodText()</span>
        </div>
    }
    else
    {
        <div class="chart-placeholder">
            <div class="placeholder-icon">ðŸ“ˆ</div>
            <p>No data to display</p>
        </div>
    }
</div>

@code {
    [Parameter] public List<ChartDataPoint>? Data { get; set; }
    [Parameter] public EventCallback OnDataChanged { get; set; }
    [Inject] private WeightService WeightService { get; set; } = default!;

    private List<ChartPoint> chartPoints = new();
    private List<ChartDataPoint> filteredData = new();
    private decimal minWeight = 0;
    private decimal maxWeight = 0;
    private TimePeriod selectedPeriod = TimePeriod.Month;
    
    // Tooltip state
    private bool showTooltip = false;
    private ChartPoint? tooltipData = null;
    private double tooltipX = 0;
    private double tooltipY = 0;
    
    // Edit popup state
    private bool showEditPopup = false;
    private ChartPoint? selectedPoint = null;
    private DateTime editDate = DateTime.Today;
    private decimal editWeight = 0;
    private bool isProcessing = false;
    private string currentAction = "";
    private string errorMessage = "";

    public enum TimePeriod
    {
        Week,
        Month,
        ThreeMonths,
        Year,
        AllTime
    }

    public class ChartPoint
    {
        public double X { get; set; }
        public double Y { get; set; }
        public DateTime Date { get; set; }
        public decimal Weight { get; set; }
        public Guid? RecordId { get; set; }
    }

    public class DateLabel
    {
        public string Text { get; set; } = "";
        public double Position { get; set; }
    }

    protected override void OnParametersSet()
    {
        CalculateChartPoints();
    }

    private void SelectTimePeriod(TimePeriod period)
    {
        selectedPeriod = period;
        CalculateChartPoints();
        StateHasChanged();
    }

    private void CalculateChartPoints()
    {
        chartPoints.Clear();
        filteredData.Clear();
        
        if (Data == null || !Data.Any()) return;

        var sortedData = Data.OrderBy(d => d.Date).ToList();
        var cutoffDate = GetCutoffDate();
        
        filteredData = sortedData.Where(d => d.Date >= cutoffDate).ToList();
        
        if (!filteredData.Any()) 
        {
            // Reset min/max when no data
            minWeight = 0;
            maxWeight = 100;
            return;
        }

        var actualMinWeight = filteredData.Min(d => d.Weight);
        var actualMaxWeight = filteredData.Max(d => d.Weight);
        
        // Validate data - ensure weights are reasonable
        if (actualMinWeight < 0 || actualMaxWeight > 1000)
        {
            Console.WriteLine($"Warning: Unusual weight data detected. Min: {actualMinWeight}, Max: {actualMaxWeight}");
            // Filter out unreasonable weights (likely data corruption)
            filteredData = filteredData.Where(d => d.Weight > 0 && d.Weight < 1000).ToList();
            if (!filteredData.Any()) 
            {
                minWeight = 0;
                maxWeight = 100;
                return;
            }
            actualMinWeight = filteredData.Min(d => d.Weight) - 20;
            actualMaxWeight = filteredData.Max(d => d.Weight) + 20;
        }
        
        // Add reasonable padding to min/max
        var range = actualMaxWeight - actualMinWeight;
        if (range == 0)
        {
            // If all weights are the same, create a small range around the weight
            var weight = actualMinWeight;
            minWeight = weight - 2m; // 2kg below
            maxWeight = weight + 2m; // 2kg above
        }
        else if (range < 5)
        {
            // For small ranges, add fixed padding
            var padding = Math.Max(1m, range * 0.2m);
            minWeight = actualMinWeight - 5;
            maxWeight = actualMaxWeight + 5;
        }
        else
        {
            // For larger ranges, add percentage-based padding
            var padding = range * 0.1m;
            minWeight = actualMinWeight - 5;
            maxWeight = actualMaxWeight + 5;
        }
        
        // Ensure minimum weight doesn't go below 0
        if (minWeight < 0) minWeight = 0;
        
        var chartWidth = 700.0;
        var chartHeight = 200.0;
        
        for (int i = 0; i < filteredData.Count; i++)
        {
            var x = filteredData.Count == 1 ? chartWidth / 2 : i * chartWidth / Math.Max(1, filteredData.Count - 1);
            
            // Calculate Y coordinate with proper normalization
            double normalizedY;
            var weightRange = (double)(maxWeight - minWeight);
            
            if (weightRange <= 0)
            {
                // If all weights are the same or range is invalid, center the points
                normalizedY = 0.5;
            }
            else
            {
                normalizedY = (double)(filteredData[i].Weight - minWeight) / weightRange;
            }
            
            var y = chartHeight - (normalizedY * chartHeight);
            
            chartPoints.Add(new ChartPoint { 
                X = x, 
                Y = y, 
                Date = filteredData[i].Date,
                Weight = filteredData[i].Weight,
                RecordId = filteredData[i].RecordId
            });
        }
    }

    private DateTime GetCutoffDate()
    {
        var now = DateTime.Now;
        return selectedPeriod switch
        {
            TimePeriod.Week => now.AddDays(-7),
            TimePeriod.Month => now.AddMonths(-1),
            TimePeriod.ThreeMonths => now.AddMonths(-3),
            TimePeriod.Year => now.AddYears(-1),
            TimePeriod.AllTime => DateTime.MinValue,
            _ => now.AddMonths(-1)
        };
    }

    private string GetPeriodText()
    {
        return selectedPeriod switch
        {
            TimePeriod.Week => "Past Week",
            TimePeriod.Month => "Past Month",
            TimePeriod.ThreeMonths => "Past 3 Months",
            TimePeriod.Year => "Past Year",
            TimePeriod.AllTime => "All Time",
            _ => "Past Month"
        };
    }

    private string GetLinePath()
    {
        if (chartPoints.Count == 0) return "";
        if (chartPoints.Count == 1) return "";
        
        var pathData = new List<string>();
        pathData.Add($"M {chartPoints[0].X.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)} {chartPoints[0].Y.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)}");
        
        for (int i = 1; i < chartPoints.Count; i++)
        {
            pathData.Add($"L {chartPoints[i].X.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)} {chartPoints[i].Y.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)}");
        }
        
        return string.Join(" ", pathData);
    }

    private string GetAreaPath()
    {
        if (chartPoints.Count == 0) return "";
        
        var pathData = new List<string>();
        pathData.Add($"M {chartPoints[0].X.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)} 200");
        pathData.Add($"L {chartPoints[0].X.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)} {chartPoints[0].Y.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)}");
        
        for (int i = 1; i < chartPoints.Count; i++)
        {
            pathData.Add($"L {chartPoints[i].X.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)} {chartPoints[i].Y.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)}");
        }
        
        pathData.Add($"L {chartPoints[chartPoints.Count - 1].X.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)} 200");
        pathData.Add("Z");
        
        return string.Join(" ", pathData);
    }
    
    private string GetSmoothedLinePath()
    {
        if (chartPoints.Count < 3) return GetLinePath(); // Use regular line for too few points
        
        var smoothedPoints = GetSmoothedPoints();
        if (smoothedPoints.Count == 0) return "";
        
        var pathData = new List<string>();
        pathData.Add($"M {smoothedPoints[0].X.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)} {smoothedPoints[0].Y.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)}");
        
        for (int i = 1; i < smoothedPoints.Count; i++)
        {
            pathData.Add($"L {smoothedPoints[i].X.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)} {smoothedPoints[i].Y.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)}");
        }
        
        return string.Join(" ", pathData);
    }
    
    private List<ChartPoint> GetSmoothedPoints()
    {
        if (chartPoints.Count < 3) return chartPoints.ToList();
        
        var smoothedPoints = new List<ChartPoint>();
        var windowSize = Math.Min(5, Math.Max(3, chartPoints.Count / 4)); // Adaptive window size
        
        for (int i = 0; i < chartPoints.Count; i++)
        {
            var start = Math.Max(0, i - windowSize / 2);
            var end = Math.Min(chartPoints.Count - 1, i + windowSize / 2);
            
            var avgY = 0.0;
            var count = 0;
            
            for (int j = start; j <= end; j++)
            {
                avgY += chartPoints[j].Y;
                count++;
            }
            
            avgY /= count;
            
            smoothedPoints.Add(new ChartPoint
            {
                X = chartPoints[i].X,
                Y = avgY,
                Date = chartPoints[i].Date,
                Weight = chartPoints[i].Weight,
                RecordId = chartPoints[i].RecordId
            });
        }
        
        return smoothedPoints;
    }

    private List<DateLabel> GetDateLabels()
    {
        var labels = new List<DateLabel>();
        
        if (!filteredData.Any()) return labels;
        
        var labelCount = Math.Min(5, filteredData.Count);
        
        for (int i = 0; i < labelCount; i++)
        {
            var index = i * Math.Max(1, filteredData.Count - 1) / Math.Max(1, labelCount - 1);
            if (index >= filteredData.Count) index = filteredData.Count - 1;
            
            var date = filteredData[index].Date;
            var text = selectedPeriod switch
            {
                TimePeriod.Week => date.ToString("MMM dd"),
                TimePeriod.Month => date.ToString("MMM dd"),
                TimePeriod.ThreeMonths => date.ToString("MMM yyyy"),
                TimePeriod.Year => date.ToString("MMM yyyy"),
                TimePeriod.AllTime => date.ToString("MMM yyyy"),
                _ => date.ToString("MMM dd")
            };
            
            var position = filteredData.Count == 1 ? 50.0 : i * 100.0 / Math.Max(1, labelCount - 1);
            
            labels.Add(new DateLabel { Text = text, Position = position });
        }
        
        return labels;
    }
    
    private void ShowTooltip(ChartPoint point, MouseEventArgs e)
    {
        showTooltip = true;
        tooltipData = point;
        tooltipX = e.ClientX - 350;
        tooltipY = e.ClientY - 200; 
        StateHasChanged();
    }
    
    private void HideTooltip()
    {
        showTooltip = false;
        tooltipData = null;
        StateHasChanged();
    }
    
    private void ShowEditPopup(ChartPoint point)
    {
        selectedPoint = point;
        editDate = point.Date;
        editWeight = point.Weight;
        showEditPopup = true;
        errorMessage = "";
        StateHasChanged();
    }
    
    private void CloseEditPopup()
    {
        showEditPopup = false;
        selectedPoint = null;
        errorMessage = "";
        isProcessing = false;
        currentAction = "";
        StateHasChanged();
    }
    
    private async Task UpdateRecord()
    {
        if (selectedPoint?.RecordId == null) return;
        
        try
        {
            isProcessing = true;
            currentAction = "update";
            errorMessage = "";
            StateHasChanged();
            
            await WeightService.UpdateWeightRecordAsync(selectedPoint.RecordId.Value, editWeight, editDate);
            await OnDataChanged.InvokeAsync();
            CloseEditPopup();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error updating record: {ex.Message}";
            isProcessing = false;
            currentAction = "";
            StateHasChanged();
        }
    }
    
    private async Task DeleteRecord()
    {
        if (selectedPoint?.RecordId == null) return;
        
        try
        {
            isProcessing = true;
            currentAction = "delete";
            errorMessage = "";
            StateHasChanged();
            
            await WeightService.DeleteWeightRecordAsync(selectedPoint.RecordId.Value);
            await OnDataChanged.InvokeAsync();
            CloseEditPopup();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting record: {ex.Message}";
            isProcessing = false;
            currentAction = "";
            StateHasChanged();
        }
    }
}