@page "/"
@using WeightTracker.Domain.Entities
@using Microsoft.AspNetCore.Components.Forms
@using WeightTracker.Shared.DTOs.Responses.Import
@using WeightTracker.Shared.DTOs.Requests.Import
@inject WeightService WeightService
@inject AuthService AuthService
@implements IDisposable

<div class="container fade-in-up">
    <div class="dashboard-header">
        <div class="welcome-section">
            <h1 class="gradient-text">Welcome back, @(currentUser?.Username ?? "User")!</h1>
            <p class="welcome-subtitle">Track your weight journey and reach your goals</p>
        </div>

        <div class="quick-actions">
            <button class="btn btn-primary animate-pulse" @onclick="ShowAddWeightModal">
                Add Today's Weight
            </button>
            <span class="quick-actions-or">or</span>
            <button class="btn btn-secondary animate-pulse" @onclick="ShowImportModal">
                Import Data
            </button>
        </div>
    </div>

    <div class="grid grid-cols-4 mb-4">
        <div class="stat-card fade-in-up stagger-1">
            <div class="stat-value">@(weightStats?.CurrentWeight.ToString("F1") ?? "-")</div>
            <div class="stat-label">Current Weight (kg)</div>
            @if (weightStats?.WeightChange.HasValue == true)
            {
                <div class="stat-change @(weightStats.WeightChange >= 0 ? "positive" : "negative")">
                    @(weightStats.WeightChange >= 0 ? "+" : "")@weightStats.WeightChange.Value.ToString("F1") kg
                </div>
            }
        </div>

        <div class="second-card card fade-in-up stagger-2">
            <div class="card-body text-center">
                <div class="stat-value text-primary">@(weightStats?.TotalEntries ?? 0)</div>
                <div class="stat-label">Total Entries</div>
            </div>
        </div>

        <div class="second-card card fade-in-up stagger-3">
            <div class="card-body text-center">
                <div class="stat-value text-primary">
                    @if (weightStats?.TotalChange.HasValue == true)
                    {
                        <span class="@(weightStats.TotalChange >= 0 ? "text-danger" : "text-success")">
                            @(weightStats.TotalChange >= 0 ? "+" : "")@weightStats.TotalChange.Value.ToString("F1")
                        </span>
                    }
                    else
                    {
                        <span>-</span>
                    }
                </div>
                <div class="stat-label">Total Change (kg)</div>
            </div>
        </div>

        <div class="second-card card fade-in-up stagger-4">
            <div class="card-body text-center">
                <div class="stat-value text-primary">
                    @if (weightStats?.LastEntry.HasValue == true)
                    {
                        <span>@weightStats.LastEntry.Value.ToString("MMM dd")</span>
                    }
                    else
                    {
                        <span>-</span>
                    }
                </div>
                <div class="stat-label">Last Entry</div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-2">
        <div class="card fade-in-right stagger-1">
            <div class="card-header">
                <h3 class="card-title">Weight Trend</h3>
                <p class="card-subtitle">Last 30 days</p>
            </div>
            <div class="card-body">
                @if (chartData?.Any() == true)
                {
                    <WeightChart Data="chartData" OnDataChanged="LoadData" />
                }
                else
                {
                    <div class="empty-state">
                        <h4>No data yet</h4>
                        <p>Add some weight entries to see your progress chart</p>
                        <button class="btn btn-primary btn-sm animate-glow" @onclick="ShowAddWeightModal">
                            Add First Entry
                        </button>
                    </div>
                }
            </div>
        </div>

        <div class="card fade-in-right stagger-2">
            <div class="card-header">
                <h3 class="card-title">Recent Entries</h3>
                <a href="/profile" class="card-action">View Profile →</a>
            </div>
            <div class="card-body p-0">
                @if (recentEntries?.Any() == true)
                {
                    @foreach (var entry in recentEntries.Take(5))
                    {
                        <div class="weight-entry-item">
                            <div class="weight-entry-info">
                                <div class="weight-entry-date">@entry.Date.ToString("MMM dd, yyyy")</div>
                                @if (!string.IsNullOrEmpty(entry.Notes))
                                {
                                    <div class="weight-entry-notes">@entry.Notes</div>
                                }
                            </div>
                            <div class="weight-entry-actions">
                                <div class="weight-entry-weight">@entry.Weight.ToString("F1") kg</div>
                                <button class="btn-edit" @onclick="() => ShowEditWeightModal(entry)" title="Edit entry">
                                    ✏️
                                </button>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="empty-state-small">
                        <p>No weight entries yet</p>
                        <button class="btn btn-primary btn-sm" @onclick="ShowAddWeightModal">
                            Add First Entry
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Add Weight Modal -->
@if (showAddWeightModal)
{
    <div class="modal-overlay" @onclick="CloseAddWeightModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>@(isEditMode ? "Edit Weight Entry" : "Add Weight Entry")</h3>
                <button class="modal-close" @onclick="CloseAddWeightModal">&times;</button>
            </div>

            <form @onsubmit="SaveWeightEntry" @onsubmit:preventDefault="true">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" @bind="newWeightEntry.Date" @bind:format="yyyy-MM-dd" class="form-control" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Weight (kg)</label>
                        <input type="number" @bind="newWeightEntry.Weight" step="0.1" class="form-control" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notes (optional)</label>
                        <textarea @bind="newWeightEntry.Notes" class="form-control" rows="3"
                            placeholder="Add any notes about your weight today..."></textarea>
                    </div>
                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="error-message mt-2">@ErrorMessage</div>
                    }
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseAddWeightModal">Cancel</button>
                    <button type="submit" class="btn btn-primary" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="spinner"></span>
                            <span>Saving...</span>
                        }
                        else
                        {
                            <span>Save Entry</span>
                        }
                    </button>
                </div>
            </form>
        </div>
    </div>
}

<!-- Import Data Modal -->
@if (showImportModal)
{
    <div class="modal-overlay" @onclick="CloseImportModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Import Weight Data</h3>
                <button class="modal-close" @onclick="CloseImportModal">&times;</button>
            </div>

            <div class="modal-body">
                @if (!showConflicts)
                {
                    <div class="form-group">
                        <label class="form-label">Select JSON file</label>
                        <InputFile OnChange="@OnFileSelected" class="form-control" accept=".json" />
                        @if (!string.IsNullOrEmpty(selectedFileName))
                        {
                            <div class="mt-2 text-success">Selected: @selectedFileName</div>
                        }
                    </div>

                    <div class="form-group">
                        <label class="form-label">File Format</label>
                        <div class="format-info">
                            <p class="text-muted">Supported formats:</p>
                            <ul class="text-muted small">
                                <li><strong>Legacy format:</strong> {"weights":[{"date":1676325600000,"weight":71.0}]}</li>
                                <li><strong>Standard format:</strong> [{"date":"2023-02-13","weight":71.0}]</li>
                            </ul>
                        </div>
                    </div>
                }
                else
                {
                    <div class="conflicts-section">
                        <h4>Data Conflicts Found</h4>
                        <p class="text-muted">The following dates already have weight entries. Choose which data to keep:</p>
                        
                        <div class="conflicts-list">
                            @foreach (var conflict in conflictingItems)
                            {
                                var conflictDate = DateTimeOffset.FromUnixTimeMilliseconds(conflict.Date).DateTime;
                                <div class="conflict-item">
                                    <div class="conflict-date">
                                        <strong>@conflictDate.ToString("dd/MM/yyyy")</strong>
                                    </div>
                                    <div class="conflict-choice">
                                        <label>
                                            <input type="radio" name="conflict_@conflict.Date" value="keep" checked="@(!conflict.Overwrite)" 
                                                   @onchange="() => SetConflictChoice(conflict, false)" />
                                            Keep existing data
                                        </label>
                                        <label>
                                            <input type="radio" name="conflict_@conflict.Date" value="overwrite" checked="@conflict.Overwrite" 
                                                   @onchange="() => SetConflictChoice(conflict, true)" />
                                            Use import data (@conflict.Weight kg)
                                        </label>
                                    </div>
                                </div>
                            }
                        </div>
                        
                        <div class="bulk-actions">
                            <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="() => SetAllConflicts(false)">
                                Keep All Existing
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="() => SetAllConflicts(true)">
                                Use All Import Data
                            </button>
                        </div>
                    </div>
                }

                @if (!string.IsNullOrEmpty(ImportMessage))
                {
                    <div class="@(ImportMessage.Contains("Error") ? "error-message" : "success-message") mt-2">@ImportMessage</div>
                }
            </div>

            <div class="modal-footer">
                @if (!showConflicts)
                {
                    <button type="button" class="btn btn-secondary" @onclick="CloseImportModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="ProcessImport" disabled="@(selectedFile == null || isImporting)">
                        @if (isImporting)
                        {
                            <span class="spinner"></span>
                            <span>Checking...</span>
                        }
                        else
                        {
                            <span>Next</span>
                        }
                    </button>
                }
                else
                {
                    <button type="button" class="btn btn-secondary" @onclick="BackToFileSelection">Back</button>
                    <button type="button" class="btn btn-success" @onclick="FinalizeImport" disabled="@isImporting">
                        @if (isImporting)
                        {
                            <span class="spinner"></span>
                            <span>Importing...</span>
                        }
                        else
                        {
                            <span>Import Data</span>
                        }
                    </button>
                }
            </div>
        </div>
    </div>
}

@code {
    private Users? currentUser;
    private WeightStats? weightStats;
    private List<ChartDataPoint>? chartData;
    private List<WeightEntry>? recentEntries;
    private bool showAddWeightModal = false;
    private bool isSaving = false;
    private bool isEditMode = false;
    private WeightEntry newWeightEntry = new() { Date = DateTime.Today };
    private string ErrorMessage = string.Empty;
    
    // Import functionality
    private bool showImportModal = false;
    private bool isImporting = false;
    private IBrowserFile? selectedFile = null;
    private string selectedFileName = string.Empty;
    private string ImportMessage = string.Empty;
    
    // Conflict resolution
    private List<DataFormatRequestDTO> conflictingItems = new();
    private List<DataFormatRequestDTO> allImportItems = new();
    private bool showConflicts = false;

    protected override async Task OnInitializedAsync()
    {
        currentUser = await AuthService.GetCurrentUserAsync();
        await LoadData();

        // Ascultă schimbările de autentificare
        AuthService.AuthenticationStateChanged += OnAuthenticationStateChanged;
    }

    private async void OnAuthenticationStateChanged(bool isAuthenticated)
    {
        if (isAuthenticated)
        {
            currentUser = await AuthService.GetCurrentUserAsync();
            await LoadData();
            await InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        AuthService.AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }

    private async Task LoadData()
    {
        try
        {
            var entries = await WeightService.GetWeightEntriesAsync();
            recentEntries = entries.OrderByDescending(e => e.Date).ToList();
            weightStats = await WeightService.GetWeightStatsAsync();
            chartData = await WeightService.GetChartDataAsync();
        }
        catch (Exception ex)
        {
            // Handle error - in production you'd want proper error handling
            Console.WriteLine($"Error loading data: {ex.Message}");
        }
    }

    private void ShowAddWeightModal()
    {
        isEditMode = false;
        newWeightEntry = new WeightEntry { Date = DateTime.Today };
        showAddWeightModal = true;
    }

    private void ShowEditWeightModal(WeightEntry entry)
    {
        isEditMode = true;
        newWeightEntry = new WeightEntry
        {
            Date = entry.Date,
            Weight = entry.Weight,
            Notes = entry.Notes,
            UserId = entry.UserId
        };
        showAddWeightModal = true;
    }

    private void HandleChartPointClick(DateTime date)
    {
        var entry = recentEntries?.FirstOrDefault(e => e.Date.Date == date.Date);
        if (entry != null)
        {
            ShowEditWeightModal(entry);
        }
    }

    private void CloseAddWeightModal()
    {
        showAddWeightModal = false;
        isEditMode = false;
        newWeightEntry = new() { Date = DateTime.Today };
    }

    private async Task SaveWeightEntry()
    {
        ErrorMessage = string.Empty;
        try
        {
            isSaving = true;
            newWeightEntry.UserId = currentUser?.UserId ?? Guid.Empty;

            if (!isEditMode)
            {
                WeightEntry? existingEntry = recentEntries?.FirstOrDefault(e => e.Date.Date == newWeightEntry.Date.Date);
                if (existingEntry != null)
                {
                    ErrorMessage = "An entry for this date already exists. Please edit the existing entry or choose a different date.";
                    return;
                }
            }

            await WeightService.SaveWeightEntryAsync(newWeightEntry);
            await LoadData();
            CloseAddWeightModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving entry: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private void ShowImportModal()
    {
        showImportModal = true;
        selectedFile = null;
        selectedFileName = string.Empty;
        ImportMessage = string.Empty;
        showConflicts = false;
        conflictingItems.Clear();
        allImportItems.Clear();
    }

    private void CloseImportModal()
    {
        showImportModal = false;
        selectedFile = null;
        selectedFileName = string.Empty;
        ImportMessage = string.Empty;
        showConflicts = false;
        conflictingItems.Clear();
        allImportItems.Clear();
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        selectedFileName = e.File.Name;
        ImportMessage = string.Empty;
    }

    private async Task ProcessImport()
    {
        if (selectedFile == null) return;

        try
        {
            isImporting = true;
            ImportMessage = string.Empty;

            // Detectează conflictele
            conflictingItems = await WeightService.DetectConflictsAsync(selectedFile);
            
            if (conflictingItems.Any())
            {
                // Sunt conflicte, arată interfața de rezolvare
                showConflicts = true;
                // Obține toate datele pentru import
                allImportItems = await WeightService.ParseWeightFileAsync(selectedFile);
            }
            else
            {
                // Nu sunt conflicte, importă direct
                await DirectImport();
            }
        }
        catch (Exception ex)
        {
            ImportMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isImporting = false;
        }
    }

    private async Task DirectImport()
    {
        var result = await WeightService.ImportWeightDataAsync(selectedFile);
        
        if (result.Success)
        {
            ImportMessage = $"Success! {result.Message}";
            await LoadData();
            await Task.Delay(2000);
            CloseImportModal();
        }
        else
        {
            ImportMessage = $"Error: {result.Message}";
        }
    }

    private void BackToFileSelection()
    {
        showConflicts = false;
        conflictingItems.Clear();
        allImportItems.Clear();
    }

    private void SetConflictChoice(DataFormatRequestDTO conflict, bool overwrite)
    {
        conflict.Overwrite = overwrite;
        // Actualizează și în lista completă
        var allItem = allImportItems.FirstOrDefault(x => x.Date == conflict.Date);
        if (allItem != null)
        {
            allItem.Overwrite = overwrite;
        }
    }

    private void SetAllConflicts(bool overwrite)
    {
        foreach (var conflict in conflictingItems)
        {
            conflict.Overwrite = overwrite;
            var allItem = allImportItems.FirstOrDefault(x => x.Date == conflict.Date);
            if (allItem != null)
            {
                allItem.Overwrite = overwrite;
            }
        }
        StateHasChanged();
    }

    private async Task FinalizeImport()
    {
        try
        {
            isImporting = true;
            ImportMessage = string.Empty;

            // Importă cu alegerile utilizatorului
            var result = await WeightService.ImportWithConflictChoicesAsync(allImportItems);
            
            if (result.Success)
            {
                ImportMessage = $"Success! {result.Message}";
                await LoadData();
                await Task.Delay(2000);
                CloseImportModal();
            }
            else
            {
                ImportMessage = $"Error: {result.Message}";
            }
        }
        catch (Exception ex)
        {
            ImportMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isImporting = false;
        }
    }

    // Metodă veche pentru compatibilitate
    private async Task ImportData()
    {
        await ProcessImport();
        }
    }
}