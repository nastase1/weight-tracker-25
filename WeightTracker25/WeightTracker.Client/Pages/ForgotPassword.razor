@page "/forgot-password"
@using WeightTracker.Shared.DTOs.Requests.User
@using WeightTracker.Shared.DTOs.Responses.User
@inject HttpClient Http
@inject NavigationManager Navigation

<div class="auth-container">
    <div class="auth-content">
        <div class="auth-card">
            <div class="auth-header">
                    <div class="auth-logo">
                    <h1 class="logo-text">WeightTracker</h1>
                </div>
                @if (!_codeSent)
                {
                    <p class="auth-subtitle">Enter your email to receive a reset code</p>
                }
                else
                {
                    <p class="auth-subtitle">Check your email and enter the code below</p>
                }
            </div>

            @if (!_codeSent)
            {
                <div class="auth-form">
                    <form @onsubmit="SendResetCode" @onsubmit:preventDefault="true">
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <div class="input-wrapper">
                                <svg class="input-icon" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                                </svg>
                                <input type="email" @bind="_forgotRequest.Email" class="form-control" 
                                       placeholder="Enter your email address" required />
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(_errorMessage))
                        {
                            <div class="alert alert-danger">
                                <svg class="alert-icon" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                          d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                          clip-rule="evenodd" />
                                </svg>
                                @_errorMessage
                            </div>
                        }

                        <button type="submit" class="btn btn-primary btn-lg w-full" disabled="@_isLoading">
                            @if (_isLoading)
                            {
                                <div class="btn-loading">
                                    <div class="spinner"></div>
                                    <span>Sending reset code...</span>
                                </div>
                            }
                            else
                            {
                                <span>Send Reset Code</span>
                                <svg class="btn-icon" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                                </svg>
                            }
                        </button>
                    </form>
                </div>
            }
            else
            {
                <div class="auth-form">
                    <form @onsubmit="ResetPassword" @onsubmit:preventDefault="true">
                        <div class="form-group">
                            <label class="form-label">Reset Code (6 digits)</label>
                            <div class="input-wrapper">
                                <svg class="input-icon" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                          d="M18 8A6 6 0 006 8v1H5a3 3 0 00-3 3v6a3 3 0 003 3h10a3 3 0 003-3v-6a3 3 0 00-3-3h-1V8zm-7 0a3 3 0 013-3h.01a3 3 0 013 3v1H8V8z"
                                          clip-rule="evenodd" />
                                </svg>
                                <input type="text" @bind="_resetRequest.ResetCode" maxlength="6" class="form-control" 
                                       placeholder="Enter 6-digit code" required />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">New Password</label>
                            <div class="input-wrapper">
                                <svg class="input-icon" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                          d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                                          clip-rule="evenodd" />
                                </svg>
                                <input type="password" @bind="_resetRequest.NewPassword" class="form-control" 
                                       placeholder="Create a strong password" required />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Confirm Password</label>
                            <div class="input-wrapper">
                                <svg class="input-icon" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                          d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                          clip-rule="evenodd" />
                                </svg>
                                <input type="password" @bind="_resetRequest.ConfirmPassword" class="form-control" 
                                       placeholder="Confirm your password" required />
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(_errorMessage))
                        {
                            <div class="alert alert-danger">
                                <svg class="alert-icon" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                          d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                          clip-rule="evenodd" />
                                </svg>
                                @_errorMessage
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(_successMessage))
                        {
                            <div class="alert alert-success">
                                <svg class="alert-icon" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                          d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                          clip-rule="evenodd" />
                                </svg>
                                @_successMessage
                            </div>
                        }

                        <button type="submit" class="btn btn-primary btn-lg w-full" disabled="@_isLoading">
                            @if (_isLoading)
                            {
                                <div class="btn-loading">
                                    <div class="spinner"></div>
                                    <span>Resetting password...</span>
                                </div>
                            }
                            else
                            {
                                <span>Reset Password</span>
                                <svg class="btn-icon" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                          d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                                          clip-rule="evenodd" />
                                </svg>
                            }
                        </button>
                    </form>
                </div>
            }

            <div class="auth-footer">
                <div style="text-align: center; padding-top: 1rem;">
                    <a href="/auth" class="forgot-password">Back to Login</a>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ForgotPasswordRequestDTO _forgotRequest = new();
    private ResetPasswordRequestDTO _resetRequest = new();
    private bool _codeSent;
    private bool _isLoading;
    private string _errorMessage = string.Empty;
    private string _successMessage = string.Empty;

    private async Task SendResetCode()
    {
        try
        {
            _isLoading = true;
            _errorMessage = string.Empty;

            var response = await Http.PostAsJsonAsync("api/Authentification/forgot-password", _forgotRequest);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ForgotPasswordResponseDTO>();
                if (result?.Success == true)
                {
                    _codeSent = true;
                    _resetRequest.Email = _forgotRequest.Email;
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                _errorMessage = $"Failed to send reset code. Status: {response.StatusCode}. Details: {errorContent}";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ResetPassword()
    {
        try
        {
            _isLoading = true;
            _errorMessage = string.Empty;

            var response = await Http.PostAsJsonAsync("api/Authentification/reset-password", _resetRequest);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ResetPasswordResponseDTO>();
                if (result?.Success == true)
                {
                    _successMessage = "Password reset successfully! Redirecting to login...";
                    await Task.Delay(2000);
                    Navigation.NavigateTo("/auth");
                }
            }
            else
            {
                _errorMessage = "Invalid reset code or email.";
            }
        }
        catch
        {
            _errorMessage = "An error occurred. Please try again.";
        }
        finally
        {
            _isLoading = false;
        }
    }
}