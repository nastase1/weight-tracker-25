@using WeightTracker.Client.Services
@using WeightTracker.Domain.Entities
@using Microsoft.AspNetCore.Components
@inject AuthService AuthService
@inject NavigationManager Navigation
@inherits LayoutComponentBase
@implements IDisposable

<div class="main-layout">
    @if (isAuthenticated)
    {
        <header class="header">
            <nav class="navbar">
                <div class="container">
                    <div class="navbar-brand">
                        <a href="/" class="brand-link">
                            <span class="brand-text">WeightTracker</span>
                        </a>
                    </div>
                    
                    <div class="navbar-nav">
                        <a href="/" class="nav-link @(IsCurrentPage("/") ? "active" : "")">
                            Dashboard
                        </a>
                        <a href="/analytics" class="nav-link @(IsCurrentPage("/analytics") ? "active" : "")">
                            Analytics
                        </a>
                         <a href="/profile" class="nav-link @(IsCurrentPage("/profile") ? "active" : "")">
                            Profile
                        </a>
                        @if (currentUser?.IsAdmin == true)
                        {
                            <a href="/admin" class="nav-link @(IsCurrentPage("/admin") ? "active" : "")">
                                Admin
                            </a>
                        }
                        
                        <div class="nav-divider"></div>
                        
                        <button class="btn btn-secondary btn-sm" @onclick="HandleLogout">
                            Logout
                        </button>
                    </div>
                </div>
            </nav>
        </header>
        
        <main class="main-content" style="flex: 1;">
            @Body
        </main>
        
        <WeightTracker.Client.Components.VersionFooter />
    }
    else
    {
        <div class="auth-layout" style="flex: 1;">
            @Body
        </div>
        
        <WeightTracker.Client.Components.VersionFooter />
    }
</div>

@code {
    private bool isAuthenticated = false;
    private Users? currentUser;

    protected override async Task OnInitializedAsync()
    {
        isAuthenticated = await AuthService.IsAuthenticatedAsync();
        
        if (isAuthenticated)
        {
            currentUser = await AuthService.GetCurrentUserAsync();
        }
        
        AuthService.AuthenticationStateChanged += OnAuthenticationStateChanged;
        
        if (!isAuthenticated && !Navigation.Uri.Contains("/auth"))
        {
            Navigation.NavigateTo("/auth");
        }
    }

    private async void OnAuthenticationStateChanged(bool authenticated)
    {
        isAuthenticated = authenticated;
        
        if (authenticated)
        {
            currentUser = await AuthService.GetCurrentUserAsync();
            Navigation.NavigateTo("/");
        }
        else
        {
            currentUser = null;
            Navigation.NavigateTo("/auth");
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
    }

    private bool IsCurrentPage(string path)
    {
        var currentPath = new Uri(Navigation.Uri).AbsolutePath;
        return string.Equals(currentPath, path, StringComparison.OrdinalIgnoreCase);
    }

    public void Dispose()
    {
        if (AuthService != null)
        {
            AuthService.AuthenticationStateChanged -= OnAuthenticationStateChanged;
        }
    }
}
